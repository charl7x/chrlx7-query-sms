# 阿里云短信查询导出工具

一个简单易用的Python CLI工具，用于查询阿里云短信服务中指定手机号在某个时间段内的发送明细，并导出为Excel文件。

## 功能特性

- ✅ 查询指定手机号的短信发送记录
- ✅ 支持自定义时间范围查询
- ✅ 自动分页获取所有记录
- ✅ 导出为格式化的Excel文件
- ✅ 彩色状态显示（成功/失败/等待）
- ✅ 详细的统计信息

## 安装步骤

### 1. 克隆或下载项目

```bash
cd /Users/bcxy/Workspace/query_sms
```

### 2. 安装依赖

建议使用虚拟环境：

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate
# Windows:
# venv\Scripts\activate

# 安装依赖包
pip install -r requirements.txt
```

### 3. 配置阿里云访问密钥

#### 获取AccessKey

1. 登录[阿里云控制台](https://ram.console.aliyun.com/manage/ak)
2. 在右上角头像处选择 "AccessKey管理"
3. 创建AccessKey（如果还没有）
4. 记录AccessKey ID和AccessKey Secret

⚠️ **安全提示**：请妥善保管您的AccessKey，不要泄露给他人或提交到代码仓库。

#### 配置环境变量

复制环境变量示例文件并填入您的配置：

```bash
cp env.example .env
```

编辑 `.env` 文件，填入您的AccessKey信息：

```bash
ALIYUN_ACCESS_KEY_ID=your_access_key_id_here
ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret_here
ALIYUN_REGION=cn-hangzhou
```

## 使用方法

### 基本用法

```bash
python main.py --phone 手机号 --start-date 开始日期 --end-date 结束日期
```

### 参数说明

| 参数 | 简写 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| `--phone` | `-p` | ✅ | 要查询的手机号码 | 13800138000 |
| `--start-date` | `-s` | ❌ | 开始日期（格式：YYYYMMDD），默认为今天 | 20231101 |
| `--end-date` | `-e` | ❌ | 结束日期（格式：YYYYMMDD），默认为开始日期 | 20231103 |
| `--output` | `-o` | ❌ | 输出文件名，默认为 sms_details.xlsx | my_sms.xlsx |
| `--workers` | `-w` | ❌ | 并发查询线程数（1-20），默认为10 | 15 |

### 使用示例

#### 1. 查询今天的短信记录

```bash
python main.py --phone 13800138000
```

#### 2. 查询指定日期的短信记录

```bash
python main.py --phone 13800138000 --start-date 20231103
```

#### 3. 查询指定时间段的短信记录

```bash
python main.py --phone 13800138000 --start-date 20231101 --end-date 20231103
```

#### 4. 自定义输出文件名

```bash
python main.py -p 13800138000 -s 20231101 -e 20231103 -o report.xlsx
```

#### 5. 查询最近7天的记录

```bash
# 手动计算日期，或使用以下方式
python main.py -p 13800138000 -s 20231027 -e 20231103
```

#### 6. 使用更高并发数加速查询（查询大时间跨度时推荐）

```bash
# 使用15个并发线程，适合查询数月或一年的数据
python main.py -p 13800138000 -s 20240101 -e 20241231 -w 15
```

## 输出说明

### 命令行输出

程序运行时会显示：
- 查询参数信息
- 配置加载状态
- 查询进度
- 统计信息（总数、成功数、失败数、等待回执数）

示例输出：

```
============================================================
阿里云短信查询导出工具
============================================================
手机号码: 13800138000
开始日期: 2023-11-01
结束日期: 2023-11-03
并发线程: 10
输出文件: sms_details.xlsx
============================================================

正在加载配置...
✓ 配置加载成功

正在初始化阿里云客户端...
✓ 客户端初始化成功

开始查询短信记录...
------------------------------------------------------------
正在查询手机号 13800138000 从 20231101 到 20231103 的短信记录...
共需查询 3 天的数据
使用 10 个并发线程加速查询...

[1/3] ✓ 20231101 找到 25 条记录
[2/3] ✓ 20231102 找到 30 条记录
[3/3] ✓ 20231103 找到 25 条记录

查询完成，共获取 80 条记录
------------------------------------------------------------

统计信息:
  总记录数: 80
  发送成功: 75
  发送失败: 3
  等待回执: 2

正在导出到Excel文件: sms_details.xlsx
成功导出 80 条记录到文件: sms_details.xlsx

✓ 任务完成!
============================================================
```

### Excel文件格式

导出的Excel文件包含以下列：

| 列名 | 说明 |
|------|------|
| 手机号 | 接收短信的手机号码 |
| 发送时间 | 短信发送的具体时间 |
| 发送状态 | 发送状态（发送成功/发送失败/等待回执） |
| 短信内容 | 短信的实际内容 |

**样式特性**：
- 表头使用蓝色背景，白色粗体文字
- 发送成功的记录用绿色背景标注
- 发送失败的记录用红色背景标注
- 自动调整列宽以适应内容

## 常见问题

### 1. 配置错误

**问题**：提示 "未找到 ALIYUN_ACCESS_KEY_ID 配置"

**解决**：确保已创建 `.env` 文件并填入正确的配置信息。

### 2. 查询不到记录

**原因可能有**：
- 该手机号在指定时间段内确实没有发送记录
- 日期格式不正确（应为 YYYYMMDD）
- AccessKey权限不足

**解决**：
- 检查日期范围是否正确
- 确认AccessKey具有短信服务的查询权限

### 3. API调用失败

**原因可能有**：
- AccessKey配置错误
- 网络连接问题
- 阿里云服务异常

**解决**：
- 检查 `.env` 文件中的配置
- 确认网络连接正常
- 查看错误信息中的具体提示

### 4. 日期格式问题

**正确格式**：YYYYMMDD（8位数字）

示例：
- ✅ 正确：20231103
- ❌ 错误：2023-11-03
- ❌ 错误：2023/11/03
- ❌ 错误：23-11-03

## 注意事项

1. **API限制**：阿里云短信API单次最多返回50条记录，本工具会自动分页查询所有记录。

2. **日期范围**：
   - 阿里云API每次只能查询单天数据，本工具会自动遍历日期范围
   - 支持并行查询，可大幅提升大时间跨度的查询速度
   - 使用默认10线程：查询1年数据约需要1-2分钟
   - 使用15-20线程：查询速度可提升50%以上

3. **并发控制**：
   - 默认并发数为10，适合大多数场景
   - 如果遇到API限流错误，可降低并发数（如 `-w 5`）
   - 查询大时间跨度时，可提高并发数（如 `-w 15` 或 `-w 20`）

4. **权限要求**：使用的AccessKey需要具有短信服务的查询权限（`QuerySendDetails`）。

5. **数据安全**：
   - `.env` 文件已在 `.gitignore` 中，不会被提交到代码仓库
   - 导出的Excel文件也已被忽略，注意不要将其提交到公开仓库

6. **性能优化**：
   - 使用多线程并行查询，大幅提升查询速度
   - 查询结果自动按时间排序
   - 实时显示查询进度

## 技术栈

- Python 3.7+
- 阿里云短信SDK (alibabacloud-dysmsapi20170525)
- Click (命令行框架)
- openpyxl (Excel操作)
- python-dotenv (环境变量管理)

## 项目结构

```
query_sms/
├── main.py              # CLI入口程序
├── config.py            # 配置管理
├── sms_query.py         # 短信查询逻辑
├── excel_export.py      # Excel导出功能
├── requirements.txt     # Python依赖
├── env.example          # 环境变量示例
├── .gitignore          # Git忽略文件
└── README.md           # 本文档
```

## 打包部署

如果你想将程序打包成独立的可执行文件，无需Python环境即可使用：

### 快速打包

```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 运行打包脚本
python build.py
```

打包完成后，在 `release/` 目录会生成可直接使用的可执行文件。

### 使用打包后的程序

```bash
cd release
cp env.example .env
# 编辑 .env 填入阿里云凭证
./query-sms -p 13800138000 -s 20231103
```

### 详细文档

- 📖 [快速打包指南](打包说明-快速版.md) - 简明扼要的打包步骤
- 📚 [完整打包文档](BUILD.md) - 详细的打包说明和常见问题

### 使用 Make 命令

项目提供了 Makefile 简化常用操作：

```bash
make help      # 查看所有可用命令
make install   # 安装依赖
make build     # 打包可执行文件
make clean     # 清理构建文件
make release   # 清理并重新打包
```

## 许可证

本项目仅供学习和个人使用。

## 支持

如有问题或建议，请联系开发者。
